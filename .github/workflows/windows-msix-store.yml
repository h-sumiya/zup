name: windows-msix-store

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_NAME: zup

jobs:
  build-msix:
    name: MSIX (x64)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: beta
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows app (x64)
        run: flutter config --enable-windows-desktop && flutter build windows --release

      - name: Resolve app version
        id: meta
        shell: pwsh
        run: |
          $versionLine = (Get-Content pubspec.yaml | Where-Object { $_ -match '^version:\s*' } | Select-Object -First 1)
          if (-not $versionLine) { throw "No version found in pubspec.yaml" }
          $productVersion = ($versionLine -replace '^version:\s*', '').Split('+')[0].Trim()
          $parts = $productVersion.Split('.')
          if ($parts.Count -lt 1 -or $parts.Count -gt 4) {
            throw "Version must have 1 to 4 numeric parts for MSIX: $productVersion"
          }
          if (($parts | Where-Object { $_ -notmatch '^\d+$' }).Count -gt 0) {
            throw "Version contains non-numeric parts: $productVersion"
          }
          while ($parts.Count -lt 4) { $parts += "0" }
          $msixVersion = $parts -join '.'
          "product_version=$productVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "msix_version=$msixVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Build MSIX for Store (x64)
        id: msix
        shell: pwsh
        env:
          PRODUCT_VERSION: ${{ steps.meta.outputs.product_version }}
          MSIX_VERSION: ${{ steps.meta.outputs.msix_version }}
        run: |
          New-Item -ItemType Directory -Path "dist" -Force | Out-Null

          $outputName = "$($env:APP_NAME)-$($env:PRODUCT_VERSION)-windows-x64"

          dart run msix:create `
            --store `
            --install-certificate false `
            --build-windows false `
            --languages en-us,ja-jp,zh-cn `
            --version $env:MSIX_VERSION `
            --output-path dist `
            --output-name $outputName

          $msixPath = Get-ChildItem -Path "dist" -Filter "*.msix" -File |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1
          if (-not $msixPath) {
            throw "MSIX package was not generated."
          }
          "msix_path=$($msixPath.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: msix-x64
          path: ${{ steps.msix.outputs.msix_path }}

  upload-release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: build-msix
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all workflow artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Show downloaded assets
        run: ls -laR dist

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            dist/**/*.msix
